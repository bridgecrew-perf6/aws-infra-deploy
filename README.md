**OVERVIEW**

**ONLY TESTED ON LONDON AWS DATACENTRE**


This is used to create and destroy AWS infrastructure. 
The following components can be created:
- Controller x1
- Worker nodes (amount defined in infra.tfvars)
- RDP Server (optional)
- NFS Server (optional)
- AD Server (optional)


### Pre-requisites

The following installed locally:

 - python3
 - netcat (nc) 
 - ssh client
 - ssh key pair (ssh-keygen -t rsa)
 - terraform (https://learn.hashicorp.com/terraform/getting-started/install.html
 - curl client
 - aws cli (https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html)

This project has been tested on Linux and OSX client machines

### Instructions

#### Setup variables and terraform

```
# ensure you have setup your aws credentials (alternatively use 'aws configure' 
# https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html)
vi ~/.aws/credentials

# clone this project
git clone https://github.com/wryszka/aws-infra-deploy
cd aws-infra-deploy

# create a copy 
cp ./etc/infra_template.template ./etc/infra.tfvars

# edit to reflect your requirements
vi ./etc/infra.tfvars 

# copy generated keypair (id_rsa and id_rsa.pub) into ./keys folder

# initialise terraform
terraform init
```

We are now ready to go ...

```
# create the AWS infastructure with the client_cidr_block for the network access control rules 
# automatically set from the client's IP address

echo MY_IP=$(curl -s http://ifconfig.me/ip)
terraform apply -var-file=etc/infra.tfvars \
   -var="client_cidr_block=$(curl -s http://ifconfig.me/ip)/32" -auto-approve=true

   # *NOTE*
   # If the terraform apply command returns an error like `invalid CIDR address: /32`, 
   # check curl actually returned an IP address

# At this point if the apply command finished successfully, you have the AWS infrastructure 
# ready for a software installation.  

### Setup a NFS server (optional)

If you want the terraform script to deploy a NFS server (e.g. for ML OPS projects), set `nfs_server_enabled=true` in your `infra.tfvars` file.

You will need to run `terraform apply ...` after making the update.  

Run `terraform output nfs_server_private_ip` to get the NFS server ip address.  The nfs share is set as `/nfsroot`.

### Setup an Active Directory (optional)

See [./docs/README-AD.md](./docs/README-AD.md) for more information.

### Client IP changed?

Re-run to update the AWS network ACL and security groups

```
terraform apply -var-file=etc/infra.tfvars \
   -var="client_cidr_block=$(curl -s http://ifconfig.me/ip)/32" 
```

### Add more workers?

Set the variable `worker_count=` in `etc/infra.tfvars` to the desired number.

```
# don't forget to approve when prompted
terraform apply -var-file=etc/infra.tfvars \
   -var="client_cidr_block=$(curl -s http://ifconfig.me/ip)/32" 

# update the json data
terraform output -json > generated/output.json


### Destroy environment when finished

```
# don't forget to approve when prompted
terraform destroy -var-file=etc/infra.tfvars \
   -var="client_cidr_block=$(curl -s http://ifconfig.me/ip)/32" 
```

### Shutdown ec2 instances when not in use

Some scripts were generated by terraform for this:

- `./generated/cli_stop_ec2_instances.sh` to stop your instances
- `./generated/cli_start_ec2_instances.sh` to start your instances
- `./generated/cli_running_ec2_instances.sh` to view running instances

------
